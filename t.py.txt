import numpy as np
import pandas as pd
from scipy.optimize import brentq
import scipy.stats

class PT_variN:
    def __init__(self, df, rho, theta):
        self.N = df['gcdu_id'].values
        self.T = len(self.N)
        self.rho = rho
        self.theta = theta
        self.Nmax = max(self.N)
        self.mu = np.zeros(self.T)
        self.sigma = self._calculate_sigma()
    
    def _calculate_sigma(self):
        i, j = np.indices((self.T, self.T))
        return np.power(self.theta, np.abs(i - j))
    
    def sum_of_defaults(self, PD, rng):
        idiosyncratic_full_box = rng.normal(size=(self.Nmax, self.T))
        systematic_box = np.tile(rng.multivariate_normal(self.mu, self.sigma), (self.Nmax, 1))
        idiosyncratic_full_box[np.arange(self.Nmax)[:, None] >= self.N] = np.nan
        systematic_box[np.arange(self.Nmax)[:, None] >= self.N] = np.nan
        asset_return = np.sqrt(self.rho) * systematic_box + np.sqrt(1 - self.rho) * idiosyncratic_full_box
        asset_return[np.isnan(asset_return)] = 99999
        defaults = asset_return < scipy.stats.norm.ppf(PD)
        return defaults.sum()
    
    def simulation(self, PD, num_simulation, rng):
        return np.array([self.sum_of_defaults(PD, rng) for _ in range(num_simulation)])
    
    def obj_func(self, PD, num_simulation, N_defaults, confidence_level, rng):
        alpha = 1 - np.mean(self.simulation(PD, num_simulation, rng) <= N_defaults)
        return alpha - confidence_level
    
    def calculate_pd(self, num_simulation, N_defaults, confidence_level, rng):
        return brentq(self.obj_func, a=1e-7, b=1 - 1e-7, args=(num_simulation, N_defaults, confidence_level, rng))

# Initialize random number generator
rng = np.random.default_rng()

# Example usage
pd_best_estimate = []
pd_conservative = []
for i in range(1, 13):
    print(i)
    X = PT_variN(df=lradr_data[lradr_data.cohort_month == i], rho=0.18, theta=0.7)
    pd_best_estimate.append(X.calculate_pd(500, n_defaults, 0.50, rng))
    pd_conservative.append(X.calculate_pd(500, n_defaults, 0.85, rng))

pd_best_estimate_final = np.mean(pd_best_estimate)
pd_conservative_final = np.mean(pd_conservative) + np.std(pd_conservative)

pd.DataFrame({"Cohort_Month": np.arange(1,13), "PD_Best_Estimate": pd_best_estimate, "PD_Conservative": pd_conservative})
