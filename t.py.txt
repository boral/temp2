def add_carm_flag_type(df):
    # Step 1: Create cbflag and ccflag based on carm_instance values
    df['cbflag'] = df['carm_instance'].apply(lambda x: 1 if x == 'CARM_BANK' else 0)
    df['ccflag'] = df['carm_instance'].apply(lambda x: 1 if x != 'CARM_BANK' else 0)
    
    # Step 2: Group by 'gcdu_global_id' and calculate the sum of cbflag and ccflag
    carmflag = df.groupby('gcdu_global_id').agg(
        cbcount=('cbflag', 'sum'),
        cccount=('ccflag', 'sum')
    ).reset_index()
    
    # Step 3: Create the CARM_FLAG based on cbcount and cccount
    def get_carm_flag(row):
        if row['cbcount'] == 0:
            return 'CFCONLY'
        elif row['cccount'] == 0:
            return 'CFBONLY'
        elif row['cbcount'] > 0 and row['cccount'] > 0:
            return 'CARMBOTH'
    
    carmflag['CARM_FLAG'] = carmflag.apply(get_carm_flag, axis=1)
    
    # Step 4: Merge the carm_flag back to the original dataframe
    df = df.merge(carmflag[['gcdu_global_id', 'CARM_FLAG']], on='gcdu_global_id', how='left')
    
    # Step 5: Add CARM_TYPE based on carm_instance
    df['CARM_TYPE'] = df['carm_instance'].apply(lambda x: 'CFB' if x == 'CARM_BANK' else 'CFC')
    
    return df
